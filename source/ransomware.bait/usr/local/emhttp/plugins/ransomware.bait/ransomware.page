Menu="Utilities"
Icon="lock.png"
Title="Ransomware Protection"
---
<?
$sName = "ransomware.bait";

if ( is_file("/boot/config/plugins/ransomware.bait/filelist") ) {
  $baitExists = "true";
} else {
  $baitExists = "false";
}

if ( is_file("/boot/config/plugins/ransomware.bait/settings.json") ) {
  $allSettings = json_decode(file_get_contents("/boot/config/plugins/ransomware.bait/settings.json"),true);
  $keys = array_keys($allSettings);
  
  $settingsOutput = "<script>";
  foreach ($keys as $key) {
    $settingsOutput .= "$('#$key').val('".$allSettings[$key]."');";
  }
  $settingsOutput .= "</script>";
}

?>
<script>
URL = '/plugins/ransomware.bait/include/exec.php'

$(function() {
  if ( "<?=$baitExists?>" == "true" ) {
    $("#createBait").prop("disabled",true);
    $("#deleteBait").prop("disabled",false);
  } else {
    $("#createBait").prop("disabled",false);
    $("#deleteBait").prop("disabled",true);
  }
  $("#stopAction").val("<?=$allSettings['stopAction']?>");
});

function getSettings() {
  var settings = new Array();
  
  $(".settings").each(function() {
    var setting = $(this).val();
    var newSetting = new Array(this.id,setting);
    settings.push(newSetting);
  });
  return settings;
}

function createBait() {
  var settings = getSettings();
  swal({
    title: "Create Bait Files?",
    text: "Are you sure you want to create the bait files?  <font color='red'>Any modification or deletion of these files will immediately stop all network access to your server.</font>",
    type: "warning",
    showCancelButton: true,
    showConfirmButton: true,
    showLoaderOnConfirm: true,
    closeOnConfirm: false,
    html: true
  },
  function(isConfirm) {
    if (isConfirm) {
      swal("Creating Bait Files","This may take a minute or two","info");
      $.post(URL,{action:'createBait',settings:settings},function(data) {
        if (data) {
          $("#createBait").prop("disabled",true);
          $("#deleteBait").prop("disabled",false);
          swal({
            type: "success",
            title: "Bait Files Created",
            text: "Any modification or deletion/renaming of the files will result in network access being stopped to your server<br><br>"+data,
            showCancelButton: false,
            showConfirmButton: true,
            closeOnConfirm: true,
            allowOutsideClick: true,
            html: true
          });
        }
      });
    }
  });   
}

function deleteBait() {
  swal({
    title: "Delete Bait Files",
    text: "Are you sure you want to delete the bait files and stop monitoring them for ransomware attacks?",
    type: "warning",
    showCancelButton: true,
    showConfirmButton: true,
    showLoaderOnConfirm: true,
    closeOnConfirm: false,
    closeOnCancel: true,
    html: true
  },
  function(isConfirm) {
    if (isConfirm) {
      swal("Deleting bait files","This may take a minute or two","info");
      $.post(URL,{action:'deleteBait'},function(data) {
        if (data) {
          $("#createBait").prop("disabled",false);
          $("#deleteBait").prop("disabled",true);
          swal({
            title: "Bait Files Deleted",
            text: data,
            html: true,
            showCancelButton: false,
            showConfirmButton: true,
            closeOnConfirm: true,
            type: "success"
          });
        }
      });
    }
  });
}

function enableApply() {
  $("#apply").prop("disabled",false);
}

function applyChanges() {
  var settings = getSettings();
  $.post(URL,{action:'applySettings',settings:settings});
  $("#apply").prop("disabled",true);
}

$(function() {
  showStatus('<?=$sName?>');
});
</script>
<span id='settingsScript'><?=$settingsOutput?></span>
This detection plugin creates so-called "bait" files either within all folders of a share or only within the root rolder of each share (note that any appdata folder is specifically excluded)  If those files should change (ie: become encrypted) or if they are deleted/renamed (which seems to be how most ransomware malware operates), then SMB will be immediately stopped to prevent further encryption to your files)<br>In the unlikely event of a naming conflict between the bait files and pre-existing files already on the array, the original files will not be touched, and they will not be monitored for changes<br><br>

<font size='3' color='red'>Actions</font><br><br>
<font color='purple'>Create Bait Files</font><br>
Where To Create: <select class='settings' id='folders'>
<option value='root'>Root of shares only</option>
<option value='all'>All folders of shares</option>

<input id='createBait' type='button' onclick='createBait();' value='Create Bait Files' disabled>

<input id='deleteBait' type='button' onclick='deleteBait();' value='Delete Bait Fales' disabled>

<span id='errors'></span>